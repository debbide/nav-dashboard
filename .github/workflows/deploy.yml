name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: nav-dashboard

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ° Cloudflare
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨ Secretsï¼‰
        run: |
          echo "ä½¿ç”¨ Secrets æ›´æ–° wrangler.toml..."
          
          # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
          cat > wrangler.toml << EOF
          name = "nav-dashboard"
          main = "src/index.js"
          compatibility_date = "2024-01-01"
          
          # D1 æ•°æ®åº“ç»‘å®š
          [[d1_databases]]
          binding = "DB"
          database_name = "nav-dashboard-db"
          database_id = "${{ secrets.D1_DATABASE_ID }}"
          
          # KV å‘½åç©ºé—´ç»‘å®š
          [[kv_namespaces]]
          binding = "KV"
          id = "${{ secrets.KV_NAMESPACE_ID }}"
          
          # Pages é…ç½®
          pages_build_output_dir = "public"
          EOF
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°"
          cat wrangler.toml

      - name: åˆå§‹åŒ– D1 æ•°æ®åº“
        run: |
          echo "åˆå§‹åŒ–æ•°æ®åº“..."
          wrangler d1 execute nav-dashboard-db --file=./schema.sql --yes || echo "æ•°æ®åº“å¯èƒ½å·²åˆå§‹åŒ–"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

      - name: éƒ¨ç½² Workers
        run: |
          echo "éƒ¨ç½² Workers..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½² Pages
        run: |
          echo "éƒ¨ç½² Pages..."
          wrangler pages deploy public --project-name=${{ env.PROJECT_NAME }} --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½²æ€»ç»“
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ðŸŒ è®¿é—®åœ°å€ï¼š"
          echo "  â€¢ ä¸»é¡µ: https://${{ env.PROJECT_NAME }}.pages.dev"
          echo "  â€¢ ç®¡ç†åŽå°: https://${{ env.PROJECT_NAME }}.pages.dev/admin.html"
          echo ""
          echo "âš ï¸ é¦–æ¬¡éƒ¨ç½²åŽéœ€è¦é…ç½® Pages ç»‘å®šï¼ˆåªéœ€ä¸€æ¬¡ï¼‰ï¼š"
          echo "  è®¿é—®: https://dash.cloudflare.com â†’ Pages â†’ ${{ env.PROJECT_NAME }} â†’ Settings â†’ Functions"
          echo "  1. æ·»åŠ  D1 ç»‘å®š: å˜é‡å DB, æ•°æ®åº“ nav-dashboard-db"
          echo "  2. æ·»åŠ  KV ç»‘å®š: å˜é‡å KV, å‘½åç©ºé—´ ID ${{ secrets.KV_NAMESPACE_ID }}"
