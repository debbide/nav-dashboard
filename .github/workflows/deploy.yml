name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: nav-dashboard

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ° Cloudflare Workers
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: æ›´æ–° wrangler.toml é…ç½®
        run: |
          echo "ä½¿ç”¨ Secrets æ›´æ–° wrangler.toml..."
          
          cat > wrangler.toml << EOF
          name = "nav-dashboard"
          main = "src/index.js"
          compatibility_date = "2024-01-01"
          
          # Workers Sites - é™æ€æ–‡ä»¶æ‰˜ç®¡
          [site]
          bucket = "./public"
          
          # D1 æ•°æ®åº“ç»‘å®š
          [[d1_databases]]
          binding = "DB"
          database_name = "nav-dashboard-db"
          database_id = "${{ secrets.D1_DATABASE_ID }}"
          
          # KV å‘½åç©ºé—´ç»‘å®š
          [[kv_namespaces]]
          binding = "KV"
          id = "${{ secrets.KV_NAMESPACE_ID }}"
          EOF
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°"
          cat wrangler.toml

      - name: åˆå§‹åŒ– D1 æ•°æ®åº“
        run: |
          echo "åˆå§‹åŒ–æ•°æ®åº“..."
          wrangler d1 execute nav-dashboard-db --file=./schema.sql --remote --yes
          echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½² Workers
        run: |
          echo "éƒ¨ç½² Workersï¼ˆåŒ…å«é™æ€æ–‡ä»¶å’Œ APIï¼‰..."
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½²æ€»ç»“
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ðŸŒ è®¿é—®åœ°å€ï¼š"
          echo "  â€¢ Workers URL: https://nav-dashboard.ä½ çš„è´¦æˆ·.workers.dev"
          echo ""
          echo "ðŸ“ è¯´æ˜Žï¼š"
          echo "  - é™æ€æ–‡ä»¶å’Œ API éƒ½é€šè¿‡åŒä¸€ä¸ª Workers æä¾›"
          echo "  - D1 å’Œ KV ç»‘å®šå·²è‡ªåŠ¨é…ç½®"
          echo "  - æ— éœ€é¢å¤–é…ç½®ï¼Œç›´æŽ¥è®¿é—®å³å¯ä½¿ç”¨"
